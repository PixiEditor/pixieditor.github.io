<!doctype html>
<html lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.ff31de0ff">
<link rel="alternate" type="application/rss+xml" href="/blog/rss.xml" title="PixiEditor Blog RSS Feed">
<link rel="alternate" type="application/atom+xml" href="/blog/atom.xml" title="PixiEditor Blog Atom Feed">
<link rel="preconnect" href="https://www.google-analytics.com">
<script>window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)},ga.l=+new Date,ga("create","G-XLN6FQ07LW","auto"),ga("set","anonymizeIp",!0),ga("send","pageview")</script>
<script async src="https://www.google-analytics.com/analytics.js"></script>
<link rel="preconnect" href="https://www.google-analytics.com">
<link rel="preconnect" href="https://www.googletagmanager.com">
<script async src="https://www.googletagmanager.com/gtag/js?id=G-XLN6FQ07LW"></script>
<script>function gtag(){dataLayer.push(arguments)}window.dataLayer=window.dataLayer||[],gtag("js",new Date),gtag("config","G-XLN6FQ07LW",{anonymize_ip:!0})</script>
<script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js" async data-ad-client="ca-pub-8372287848779618"></script>
<script src="https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-8372287848779618" async crossorigin="anonymous"></script><title data-react-helmet="true">Dynamic bitmaps | PixiEditor</title><meta data-react-helmet="true" property="og:title" content="Dynamic bitmaps | PixiEditor"><meta data-react-helmet="true" name="description" content="Dynamic bitmap is a solution which made PixiEditor work multiple times faster, decreased RAM usage 10 times, and solved memory leak problems.  This article will explain what it is and how it works."><meta data-react-helmet="true" property="og:description" content="Dynamic bitmap is a solution which made PixiEditor work multiple times faster, decreased RAM usage 10 times, and solved memory leak problems.  This article will explain what it is and how it works."><meta data-react-helmet="true" property="og:url" content="https://pixieditor.net/blog/2021/07/22/dynamic-bitmaps"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_tag" content="default"><meta data-react-helmet="true" name="keywords" content="bitmap,dynamic,data-structure,image,optimization"><meta data-react-helmet="true" property="og:image" content="https://pixieditor.net/img/PixiEditorBanner.png"><meta data-react-helmet="true" name="twitter:image" content="https://pixieditor.net/img/PixiEditorBanner.png"><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><link data-react-helmet="true" rel="shortcut icon" href="/img/favicon.ico"><link data-react-helmet="true" rel="canonical" href="https://pixieditor.net/blog/2021/07/22/dynamic-bitmaps"><link data-react-helmet="true" rel="alternate" href="https://pixieditor.net/blog/2021/07/22/dynamic-bitmaps" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://pixieditor.net/blog/2021/07/22/dynamic-bitmaps" hreflang="x-default"><link rel="stylesheet" href="/assets/css/styles.5758200c.css">
<link rel="preload" href="/assets/js/runtime~main.527b398e.js" as="script">
<link rel="preload" href="/assets/js/main.0e16864b.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();t(null!==e?e:"dark")}()</script><div id="__docusaurus">
<div><a href="#main" class="skipToContent_1oUP">Skip to main content</a></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle" type="button" tabindex="0"><svg aria-label="Menu" width="30" height="30" viewBox="0 0 30 30" role="img" focusable="false"><title>Menu</title><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PixiEditor</strong></a><a class="navbar__item navbar__link" href="/docs/introduction">Docs</a><a class="navbar__item navbar__link" href="/help">Help</a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/blog">Blog</a><a class="navbar__item navbar__link" href="/colorpicker">Color Picker</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/PixiEditor/PixiEditor" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub</a><a href="https://opencollective.com/pixieditor" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">Donate ✨</a></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div><div class="navbar-sidebar"><div class="navbar-sidebar__brand"><a class="navbar__brand" href="/"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--light_3UqQ navbar__logo"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--dark_hz6m navbar__logo"><strong class="navbar__title">PixiEditor</strong></a></div><div class="navbar-sidebar__items"><div class="menu"><ul class="menu__list"><li class="menu__list-item"><a class="menu__link" href="/docs/introduction">Docs</a></li><li class="menu__list-item"><a class="menu__link" href="/help">Help</a></li><li class="menu__list-item"><a href="https://github.com/PixiEditor/PixiEditor" target="_blank" rel="noopener noreferrer" class="menu__link">GitHub</a></li><li class="menu__list-item"><a href="https://opencollective.com/pixieditor" target="_blank" rel="noopener noreferrer" class="menu__link">Donate ✨</a></li><li class="menu__list-item"><a aria-current="page" class="menu__link navbar__link--active" href="/blog">Blog</a></li><li class="menu__list-item"><a class="menu__link" href="/colorpicker">Color Picker</a></li></ul></div></div></div></nav><div class="main-wrapper blog-wrapper blog-post-page"><div class="container margin-vert--lg"><div class="row"><div class="col col--3"><div class="sidebar_2ahu thin-scrollbar"><h3 class="sidebarItemTitle_2hhb">Recent posts</h3><ul class="sidebarItemList_2xAf"><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/11/13/devlog1">Devlog 1 v0.1.7</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/08/06/todo-csharp">How to write a Todo list app in 10 lines of code in pure C# [no dependencies]</a></li><li class="sidebarItem_2UVv"><a aria-current="page" class="sidebarItemLink_1RT6 sidebarItemLinkActive_12pM" href="/blog/2021/07/22/dynamic-bitmaps">Dynamic bitmaps</a></li><li class="sidebarItem_2UVv"><a class="sidebarItemLink_1RT6" href="/blog/2021/06/06/pixieditor-net-launch">Launching PixiEditor.net</a></li></ul></div></div><main class="col col--7"><article><header><h1 class="margin-bottom--sm blogPostTitle_GeHD">Dynamic bitmaps</h1><div class="margin-vert--md"><time datetime="2021-07-22T00:00:00.000Z" class="blogPostDate_fNvV">July 22, 2021 · 6 min read</time></div><div class="avatar margin-vert--md"><a href="https://krysinski.me" target="_blank" rel="noopener noreferrer" class="avatar__photo-link avatar__photo"><img src="https://avatars.githubusercontent.com/u/25402427?s=400&amp;v=4" alt="Krzysztof Krysiński"></a><div class="avatar__intro"><h4 class="avatar__name"><a href="https://krysinski.me" target="_blank" rel="noopener noreferrer">Krzysztof Krysiński</a></h4><small class="avatar__subtitle">PixiEditor Creator</small></div></div></header><div class="markdown"><p>Dynamic bitmaps are a solution that made PixiEditor work multiple times faster, decreased RAM usage by about 10 times and solved memory leak problems.
This article will explain what dynamic bitmaps are and how they work.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="history"></a>History<a class="hash-link" href="#history" title="Direct link to heading">#</a></h2><p>Dynamic bitmaps have been introduced in a very early alpha (version v0.0.3), before that the PixiEditor image system was pretty straightforward.</p><p>Mouse clicks were converted into relative canvas coordinates, and then color was applied to the pixels at a given position. It was pretty simple, however, this solution had one big downside. PixiEditor uses <a href="https://docs.microsoft.com/pl-pl/dotnet/api/system.windows.media.imaging.writeablebitmap?view=net-5.0" target="_blank" rel="noopener noreferrer">WriteableBitmap</a>
to manipulate bitmaps and working on bigger canvases using this solution yielded bad performance and huge memory consumption.</p><p>So what was the solution? Dynamic bitmaps!</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="what-is-a-dynamic-bitmap"></a>What is a dynamic bitmap?<a class="hash-link" href="#what-is-a-dynamic-bitmap" title="Direct link to heading">#</a></h2><p>In simple words, a dynamic bitmap is a bitmap that fits the size of its content. This is crucial for the layer system.
Here is a visual representation of how it works </p><video width="650" controls=""><source src="/videos/dynamic-bitmaps.mp4" type="video/mp4"></video><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-it-works"></a>How it works<a class="hash-link" href="#how-it-works" title="Direct link to heading">#</a></h2><p>Let&#x27;s start with a simple algorithm</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">1. Create a new bitmap with a size of 0x0 (or of any other size, depending on your usage)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">2. When set pixel is requested (for example user clicked on canvas), do the following:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">3. If the color is not transparent (if alpha is not 0):</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  a. If X of given coordinates is bigger than current width or Y is bigger than height, Increase size to bottom right</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  b. Else if new colored pixel X is smaller than 0 (relative to bitmap coordinates) or Y is smaller than 0, then increase the size to top left</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  </span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">4. Else If: color is transparent and coordinates already contain non-transparent pixel and after deleting them, there is a gap between content and the bitmap:</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">  a. Decrease size of bitmap to fit content</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>  The process of resizing the bitmap is quite simple:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly"><div tabindex="0" class="prism-code language-undefined codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">1. Create a new bitmap with the desired size</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">2. Copy pixels from the current bitmap</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">3. Fill a new bitmap with the copied pixels at a calculated offset.</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>  However, the implementation is not trivial, it requires some calculations, like extracting the border pixels, calculating offsets,
checking if a coordinate is a border pixel and more.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="how-pixieditor-does-this"></a>How PixiEditor does this<a class="hash-link" href="#how-pixieditor-does-this" title="Direct link to heading">#</a></h2><p>   Our algorithms look like this:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly csharp"><div tabindex="0" class="prism-code language-csharp codeBlock_23N8 thin-scrollbar"><div class="codeBlockLines_39YC" style="color:#F8F8F2;background-color:#282A36"><div class="token-line" style="color:#F8F8F2"><span class="token plain">     public void DynamicResize(BitmapPixelChanges pixels)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         if (pixels.ChangedPixels.Count == 0)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             return;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         ResetOffset(pixels);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Tuple&lt;DoubleCords, bool&gt; borderData = ExtractBorderData(pixels);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         DoubleCords minMaxCords = borderData.Item1;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newMaxX = minMaxCords.Coords2.X - OffsetX;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newMaxY = minMaxCords.Coords2.Y - OffsetY;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newMinX = minMaxCords.Coords1.X - OffsetX;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newMinY = minMaxCords.Coords1.Y - OffsetY;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         if (!(pixels.WasBuiltAsSingleColored &amp;&amp; pixels.ChangedPixels.First().Value.A == 0)) //Check if all requested pixels are transparent</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             if ((newMaxX + 1 &gt; Width &amp;&amp; Width &lt; MaxWidth) || (newMaxY + 1 &gt; Height &amp;&amp; Height &lt; MaxHeight))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 IncreaseSizeToBottomAndRight(newMaxX, newMaxY);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             if ((newMinX &lt; 0 &amp;&amp; Width &lt; MaxWidth) || (newMinY &lt; 0 &amp;&amp; Height &lt; MaxHeight))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 IncreaseSizeToTopAndLeft(newMinX, newMinY);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         // if clip (fit bitmap to content) is requested</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         if (borderData.Item2)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             clipRequested = true;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     private void IncreaseSizeToBottomAndRight(int newMaxX, int newMaxY)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         if (MaxWidth - OffsetX &lt; 0 || MaxHeight - OffsetY &lt; 0)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             return;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         newMaxX = Math.Clamp(Math.Max(newMaxX + 1, Width), 0, MaxWidth - OffsetX);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         newMaxY = Math.Clamp(Math.Max(newMaxY + 1, Height), 0, MaxHeight - OffsetY);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         ResizeCanvas(0, 0, 0, 0, newMaxX, newMaxY);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     private void IncreaseSizeToTopAndLeft(int newMinX, int newMinY)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         newMinX = Math.Clamp(Math.Min(newMinX, Width), Math.Min(-OffsetX, OffsetX), 0);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         newMinY = Math.Clamp(Math.Min(newMinY, Height), Math.Min(-OffsetY, OffsetY), 0);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Offset = new Thickness(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             Math.Clamp(OffsetX + newMinX, 0, MaxWidth),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             Math.Clamp(OffsetY + newMinY, 0, MaxHeight),</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             0,</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             0);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newWidth = Math.Clamp(Width - newMinX, 0, MaxWidth);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int newHeight = Math.Clamp(Height - newMinY, 0, MaxHeight);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int offsetX = Math.Abs(newWidth - Width);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int offsetY = Math.Abs(newHeight - Height);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         ResizeCanvas(offsetX, offsetY, 0, 0, newWidth, newHeight);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     private void ResizeCanvas(int offsetX, int offsetY, int offsetXSrc, int offsetYSrc, int newWidth, int newHeight)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int iteratorHeight = Height &gt; newHeight ? newHeight : Height;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int count = Width &gt; newWidth ? newWidth : Width;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         using (BitmapContext srcContext = LayerBitmap.GetBitmapContext(ReadWriteMode.ReadOnly))</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             WriteableBitmap result = BitmapFactory.New(newWidth, newHeight);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             using (BitmapContext destContext = result.GetBitmapContext())</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 for (int line = 0; line &lt; iteratorHeight; line++)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     int srcOff = (((offsetYSrc + line) * Width) + offsetXSrc) * SizeOfArgb;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     int dstOff = (((offsetY + line) * newWidth) + offsetX) * SizeOfArgb;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                     BitmapContext.BlockCopy(srcContext, srcOff, destContext, dstOff, count * SizeOfArgb);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 LayerBitmap = result;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 Width = newWidth;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 Height = newHeight;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     private Tuple&lt;DoubleCords, bool&gt; ExtractBorderData(BitmapPixelChanges pixels)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         Coordinates firstCords = pixels.ChangedPixels.First().Key;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int minX = firstCords.X;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int minY = firstCords.Y;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int maxX = minX;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         int maxY = minY;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         bool clipRequested = false;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         foreach (KeyValuePair&lt;Coordinates, Color&gt; pixel in pixels.ChangedPixels)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             if (pixel.Key.X &lt; minX)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 minX = pixel.Key.X;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             else if (pixel.Key.X &gt; maxX)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 maxX = pixel.Key.X;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             if (pixel.Key.Y &lt; minY)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 minY = pixel.Key.Y;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             else if (pixel.Key.Y &gt; maxY)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 maxY = pixel.Key.Y;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             if (clipRequested == false &amp;&amp; IsBorderPixel(pixel.Key) &amp;&amp; pixel.Value.A == 0)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                 clipRequested = true;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         return new Tuple&lt;DoubleCords, bool&gt;(</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">             new DoubleCords(new Coordinates(minX, minY), new Coordinates(maxX, maxY)), clipRequested);</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain" style="display:inline-block">
</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     private bool IsBorderPixel(Coordinates cords)</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     {</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">         return cords.X - OffsetX == 0 || cords.Y - OffsetY == 0 || cords.X - OffsetX == Width - 1 ||</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">                cords.Y - OffsetY == Height - 1;</span></div><div class="token-line" style="color:#F8F8F2"><span class="token plain">     }</span></div></div></div><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o">Copy</button></div></div><p>As you can see, the code is not trivial, it takes a lot of steps, our implementation also does a bit more stuff, like requesting clips
(resizing whole document to perfectly fit the content) and clamping the maximum size. </p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="performance"></a>Performance<a class="hash-link" href="#performance" title="Direct link to heading">#</a></h2><p>Our implementation is very performant since we are using fast <code>BitmapContext.BlockCopy</code> to copy and paste pixels into a new bitmap.</p><p>It&#x27;s almost unnoticeable in real-time, with fast mouse movement small visual jittering can be visible, but there is no delay whatsoever.
How fast dynamic bitmaps work, depends on the implementation, platform, native bitmap APIs, etc.</p><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="other-benefits"></a>Other benefits<a class="hash-link" href="#other-benefits" title="Direct link to heading">#</a></h2><p>The benefits described below are not directly related to the implementation, but the usage of dynamic bitmaps.</p><p>These features are way easier to create (or possible at all), thanks to perfectly fitted bitmaps:</p><ul><li>Resize and rotate border,</li><li>Clip canvas (fit document to content),</li><li>Center content relative to document or other layers,</li><li>Snapping and guides</li><li>Efficient preview layers</li></ul><h2><a aria-hidden="true" tabindex="-1" class="anchor enhancedAnchor_2LWZ" id="conclusion"></a>Conclusion<a class="hash-link" href="#conclusion" title="Direct link to heading">#</a></h2><p>Dynamic bitmaps are a very useful structure, it helps to create a lot of small bitmaps, which can be easily reused.
No more unnecessary memory allocation and heavy CPU operations. If you want to learn more,
join our <a href="https://discord.gg/qSRMYmq" target="_blank" rel="noopener noreferrer">Discord</a>, we are open to discussions!</p></div><footer class="row margin-vert--lg"><div class="col"><strong>Tags:</strong><a class="margin-horiz--sm" href="/blog/tags/code">code</a><a class="margin-horiz--sm" href="/blog/tags/solution">solution</a></div></footer></article><div></div><div class="margin-vert--xl"><nav class="pagination-nav" aria-label="Blog post page navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/blog/2021/08/06/todo-csharp"><div class="pagination-nav__sublabel">Newer Post</div><div class="pagination-nav__label">« How to write a Todo list app in 10 lines of code in pure C# [no dependencies]</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/blog/2021/06/06/pixieditor-net-launch"><div class="pagination-nav__sublabel">Older Post</div><div class="pagination-nav__label">Launching PixiEditor.net »</div></a></div></nav></div></main><div class="col col--2"><div class="tableOfContents_35-E thin-scrollbar"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#history" class="table-of-contents__link">History</a></li><li><a href="#what-is-a-dynamic-bitmap" class="table-of-contents__link">What is a dynamic bitmap?</a></li><li><a href="#how-it-works" class="table-of-contents__link">How it works</a></li><li><a href="#how-pixieditor-does-this" class="table-of-contents__link">How PixiEditor does this</a></li><li><a href="#performance" class="table-of-contents__link">Performance</a></li><li><a href="#other-benefits" class="table-of-contents__link">Other benefits</a></li><li><a href="#conclusion" class="table-of-contents__link">Conclusion</a></li></ul></div></div></div></div></div><footer class="footer"><div class="container"><div class="row footer__links"><div class="col footer__col"><div class="footer__title">Docs</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/Introduction">Getting started</a></li></ul></div><div class="col footer__col"><div class="footer__title">Community</div><ul class="footer__items"><li class="footer__item"><a href="https://www.reddit.com/r/PixiEditor/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Reddit</a></li><li class="footer__item"><a href="https://twitter.com/PixiEditor" target="_blank" rel="noopener noreferrer" class="footer__link-item">Twitter</a></li><li class="footer__item"><a href="https://discord.gg/qSRMYmq" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discord</a></li><li class="footer__item"><a href="https://www.youtube.com/channel/UCT5XvyvX1q5PAIaXfWmpsMQ" target="_blank" rel="noopener noreferrer" class="footer__link-item">YouTube</a></li><li class="footer__item"><a href="https://instagram.com/pixi.editor" target="_blank" rel="noopener noreferrer" class="footer__link-item">Instagram</a></li></ul></div><div class="col footer__col"><div class="footer__title">More</div><ul class="footer__items"><li class="footer__item"><a href="https://opencollective.com/pixieditor" target="_blank" rel="noopener noreferrer" class="footer__link-item">Donate</a></li></ul></div><div class="col footer__col"><div class="footer__title">Legal</div><ul class="footer__items"><li class="footer__item"><a class="footer__link-item" href="/docs/privacy-policy">Privacy Policy</a></li></ul></div></div><div class="footer__bottom text--center"><div class="margin-bottom--sm"><a class="footerLogoLink_MyFc" href="/"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--light_3UqQ footer__logo"><img src="/img/favicon-96x96.png" alt="PixiEditor Logo" class="themedImage_1VuW themedImage--dark_hz6m footer__logo"></a></div><div class="footer__copyright">Copyright © 2021 PixiEditor Organization</div></div></div></footer></div>
<script src="/assets/js/runtime~main.527b398e.js"></script>
<script src="/assets/js/main.0e16864b.js"></script>
</body>
</html>